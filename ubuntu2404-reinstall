#!/bin/bash

# ==============================================================================
# Ubuntu 24.04 Network Reinstall Script
# Based on leitbogioro's approach - uses official Ubuntu Cloud Image
# Flow: AlpineLinux(netboot) -> Download Cloud Image -> DD -> cloud-init config
# ==============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PLAIN='\033[0m'

# Check root
[[ "$EUID" -ne 0 ]] && echo -e "${RED}Error: This script must be run as root!${PLAIN}" && exit 1

# Check systemd-boot
if [ -f /boot/efi/EFI/systemd/systemd-bootx64.efi ]; then
    echo -e "${RED}Error: systemd-boot is not supported. This script requires GRUB.${PLAIN}"
    exit 1
fi

# ==============================================================================
# Install dependencies
# ==============================================================================
echo -e "${BLUE}[*] Installing dependencies...${PLAIN}"
apt-get update -y >/dev/null 2>&1
apt-get install -y wget cpio gzip openssl file >/dev/null 2>&1

# ==============================================================================
# Generate credentials
# ==============================================================================
SSH_PORT=$(shuf -i 10000-65535 -n 1)
ROOT_PASS=$(tr -dc 'a-zA-Z0-9' < /dev/urandom | head -c 16)
HOSTNAME="ubuntu"
HASHED_PASS=$(openssl passwd -6 "$ROOT_PASS")

# Ubuntu Cloud Image URL (official)
UBUNTU_IMAGE_URL="https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"

clear
echo -e "${RED}==========================================================${PLAIN}"
echo -e "${RED}   WARNING: SAVE THESE CREDENTIALS NOW!                  ${PLAIN}"
echo -e "${RED}==========================================================${PLAIN}"
echo -e ""
echo -e "Target System:  ${GREEN}Ubuntu 24.04 LTS${PLAIN}"
echo -e "Hostname:       ${GREEN}$HOSTNAME${PLAIN}"
echo -e "Username:       ${GREEN}root${PLAIN}"
echo -e "Password:       ${YELLOW}$ROOT_PASS${PLAIN}"
echo -e "SSH Port:       ${YELLOW}$SSH_PORT${PLAIN}"
echo -e ""
echo -e "${YELLOW}Note: The system will be formatted. All data will be lost.${PLAIN}"
echo -e "${YELLOW}Note: Using official Ubuntu Cloud Image from cloud-images.ubuntu.com${PLAIN}"
echo -e "${RED}==========================================================${PLAIN}"
echo -e ""

read -p "I have saved the credentials. Press [Enter] to start install..."

# ==============================================================================
# Network detection
# ==============================================================================
echo -e "${BLUE}[*] Detecting network configuration...${PLAIN}"

# Get main interface
MAIN_IF=$(ip route | grep default | awk '{print $5}' | head -n1)
IP_ADDR=$(ip addr show "$MAIN_IF" | grep 'inet ' | awk '{print $2}' | cut -d'/' -f1)
IP_PREFIX=$(ip addr show "$MAIN_IF" | grep 'inet ' | awk '{print $2}' | cut -d'/' -f2)
GATEWAY=$(ip route | grep default | awk '{print $3}')
DNS1=$(grep "nameserver" /etc/resolv.conf | head -n1 | awk '{print $2}')
DNS2=$(grep "nameserver" /etc/resolv.conf | tail -n1 | awk '{print $2}')
[[ "$DNS2" == "$DNS1" ]] && DNS2="8.8.8.8"

# Check DHCP or Static
if grep -q "dhcp" /etc/netplan/*.yaml 2>/dev/null || [[ -z "$IP_ADDR" ]]; then
    NET_MODE="dhcp"
    echo -e "  Network Mode: ${GREEN}DHCP${PLAIN}"
else
    NET_MODE="static"
    echo -e "  Network Mode: ${GREEN}Static${PLAIN}"
    echo -e "  IP:           ${GREEN}$IP_ADDR/$IP_PREFIX${PLAIN}"
    echo -e "  Gateway:      ${GREEN}$GATEWAY${PLAIN}"
    echo -e "  DNS:          ${GREEN}$DNS1 $DNS2${PLAIN}"
fi

# ==============================================================================
# Prepare environment
# ==============================================================================
echo -e "${BLUE}[*] Preparing environment...${PLAIN}"

mkdir -p /boot/reinstall
cd /boot/reinstall

# Alpine Linux netboot
ALPINE_MIRROR="https://dl-cdn.alpinelinux.org/alpine/v3.20/releases/x86_64"

echo "  Downloading Alpine Linux netboot files..."
wget -qO vmlinuz-lts "$ALPINE_MIRROR/netboot/vmlinuz-lts"
wget -qO initramfs-lts "$ALPINE_MIRROR/netboot/initramfs-lts"
wget -qO modloop-lts "$ALPINE_MIRROR/netboot/modloop-lts"

# ==============================================================================
# Build initramfs with embedded script
# ==============================================================================
echo -e "${BLUE}[*] Building initramfs with embedded installation script...${PLAIN}"

mkdir -p initramfs_extracted
cd initramfs_extracted
zcat ../initramfs-lts | cpio -idm 2>/dev/null

# Create the installation script that runs in Alpine
# Note: Variables are expanded at script generation time, not at runtime
cat > init << EOF
#!/bin/sh

exec >/dev/tty0 2>&1

echo "=== Ubuntu 24.04 Installation Starting ==="

# Mount necessary filesystems
mount -t devtmpfs devtmpfs /dev 2>/dev/null || true
mount -t proc proc /proc 2>/dev/null || true
mount -t sysfs sysfs /sys 2>/dev/null || true

# Configure network
echo "[*] Configuring network..."
for iface in eth0 ens3 ens4 enp0s3 enp1s0 vnet0; do
    ip link show \$iface >/dev/null 2>&1 && MAIN_IF=\$iface && break
done
ip link set "\$MAIN_IF" up
EOF

# Add network configuration based on mode
if [[ "$NET_MODE" == "dhcp" ]]; then
    cat >> init << 'EOF'
echo "[*] Requesting DHCP..."
udhcpc -i "$MAIN_IF" -q -n -t 10 2>/dev/null || {
    echo "[WARN] DHCP failed, trying fallback..."
    ip link set "$MAIN_IF" up
    sleep 2
    udhcpc -i "$MAIN_IF" -q -n 2>/dev/null || true
}
EOF
else
    cat >> init << EOF
echo "[*] Configuring static IP..."
ip addr add $IP_ADDR/$IP_PREFIX dev "\$MAIN_IF"
ip route add default via $GATEWAY dev "\$MAIN_IF"
echo "nameserver $DNS1" > /etc/resolv.conf
echo "nameserver $DNS2" >> /etc/resolv.conf
EOF
fi

# Continue the init script with embedded values
cat >> init << EOF

echo "[*] Network configured."

# Find main disk
MAIN_DISK=\$(lsblk -dln -o NAME,TYPE | grep disk | head -n1 | awk '{print "/dev/"\$1}')
if [ -z "\$MAIN_DISK" ]; then
    MAIN_DISK="/dev/sda"
fi
echo "[*] Target disk: \$MAIN_DISK"

# Setup repositories and install tools
echo "[*] Installing required tools..."
setup-apkrepos -1 -q 2>/dev/null || true
echo "http://dl-cdn.alpinelinux.org/alpine/v3.20/main" > /etc/apk/repositories
echo "http://dl-cdn.alpinelinux.org/alpine/v3.20/community" >> /etc/apk/repositories
apk update 2>/dev/null || true
apk add wget qemu-img kpartx e2fsprogs util-linux openssl 2>/dev/null || true

# Download Ubuntu Cloud Image
echo "[*] Downloading Ubuntu 24.04 Cloud Image..."
echo "[*] This may take 5-15 minutes depending on network speed..."
wget --no-check-certificate --tries=3 --timeout=60 -O /tmp/ubuntu.img "$UBUNTU_IMAGE_URL"

if [ ! -f /tmp/ubuntu.img ]; then
    echo "[ERROR] Failed to download Ubuntu image!"
    echo "[ERROR] Check network connectivity and try again."
    sleep 30
    reboot -f
fi

echo "[*] Converting and writing image to disk..."
qemu-img convert -f qcow2 -O raw /tmp/ubuntu.img /tmp/ubuntu.raw
dd if=/tmp/ubuntu.raw of=\$MAIN_DISK bs=4M status=progress conv=fsync
sync
sync
echo "[*] Image written successfully."

# Setup loop device for partition access
echo "[*] Configuring system..."
losetup -f /tmp/ubuntu.raw
LOOP_DEV=\$(losetup -l | grep ubuntu.raw | awk '{print \$1}')
kpartx -av \$LOOP_DEV 2>/dev/null || true
sleep 2

# Find root partition (Ubuntu 24.04: first partition is root, last is boot)
ROOT_PART=\$(ls /dev/mapper/ | grep loop | head -n1)
mkdir -p /mnt

mount /dev/mapper/\$ROOT_PART /mnt 2>/dev/null || {
    # Fallback: try direct partition
    mount \${MAIN_DISK}1 /mnt 2>/dev/null || mount \${MAIN_DISK}p1 /mnt
}

if [ ! -d /mnt/etc ]; then
    echo "[ERROR] Failed to mount root partition!"
    sleep 10
    reboot -f
fi

# Configure cloud-init
echo "[*] Setting up cloud-init configuration..."
mkdir -p /mnt/etc/cloud/cloud.cfg.d

cat > /mnt/etc/cloud/cloud.cfg.d/99-installer.cfg << 'CLOUDCFG'
#cloud-config
hostname: $HOSTNAME
manage_etc_hosts: true

users:
  - name: root
    lock_passwd: false

ssh_pwauth: true

chpasswd:
  expire: false
  list:
    - root:$ROOT_PASS

runcmd:
  - sed -i 's/^#\?Port.*/Port $SSH_PORT/' /etc/ssh/sshd_config
  - sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
  - sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
  - sed -i 's|^#*Include /etc/ssh/sshd_config.d|#Include /etc/ssh/sshd_config.d|' /etc/ssh/sshd_config
  - rm -f /etc/systemd/system/ssh.service.d/*.conf 2>/dev/null || true
  - sed -i 's/^ListenStream=.*/ListenStream=$SSH_PORT/' /lib/systemd/system/ssh.socket 2>/dev/null || true

cloud_final_modules:
  - [scripts-user, always]
  - [final-message, always]
CLOUDCFG

# Disable other cloud-init data sources
echo 'datasource_list: [ NoCloud, None ]' > /mnt/etc/cloud/cloud.cfg.d/90_dpkg.cfg

# Set root password directly as backup
sed -i 's|^root:[^:]*:|root:$HASHED_PASS:|' /mnt/etc/shadow

# Hack cloud-init to ignore iso9660 (prevent cloud provider override)
UTIL_PY=\$(find /mnt/usr/lib/python* -name "util.py" -path "*/cloudinit/*" 2>/dev/null | head -n1)
if [ -n "\$UTIL_PY" ]; then
    sed -i 's/iso9660/osi9876/g' "\$UTIL_PY" 2>/dev/null || true
    sed -i 's/"blkid"/"echo"/g' "\$UTIL_PY" 2>/dev/null || true
    echo "[*] Applied cloud-init hack"
fi

# Configure GRUB for serial console
if [ -f /mnt/etc/default/grub ]; then
    sed -i 's/GRUB_CMDLINE_LINUX=""/GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0 console=tty1 console=ttyS0,115200n8"/' /mnt/etc/default/grub
    sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT=""/GRUB_CMDLINE_LINUX_DEFAULT="net.ifnames=0 biosdevname=0 console=tty1 console=ttyS0,115200n8"/' /mnt/etc/default/grub
fi

# Ensure SSH directory exists
mkdir -p /mnt/root/.ssh
chmod 700 /mnt/root/.ssh

sync
echo "[*] Unmounting..."
umount /mnt 2>/dev/null || true
kpartx -dv \$LOOP_DEV 2>/dev/null || true
losetup -d \$LOOP_DEV 2>/dev/null || true

echo ""
echo "=========================================="
echo "  Installation Complete!"
echo "  New SSH Port: $SSH_PORT"
echo "  Root Password: $ROOT_PASS"
echo "=========================================="
echo "[*] Rebooting in 5 seconds..."
sleep 5
reboot -f
EOF

chmod +x init

# Repack initramfs
echo "  Repacking initramfs..."
find . | cpio -H newc -o 2>/dev/null | gzip -9 > ../initramfs-custom.img
cd ..
rm -rf initramfs_extracted

# ==============================================================================
# Configure GRUB
# ==============================================================================
echo -e "${BLUE}[*] Configuring GRUB...${PLAIN}"

GRUB_UUID=$(grub-probe --target=fs_uuid /boot/reinstall/vmlinuz-lts 2>/dev/null)

cat > /boot/reinstall/grub.cfg << EOF
menuentry 'Ubuntu 24.04 Network Reinstall' {
    search --no-floppy --fs-uuid --set=root $GRUB_UUID
    linux /boot/reinstall/vmlinuz-lts initrd=/boot/reinstall/initramfs-custom.img console=tty0
    initrd /boot/reinstall/initramfs-custom.img
}
EOF

# Backup original grub.cfg
cp /boot/grub/grub.cfg /boot/grub/grub.cfg.bak.$(date +%s)

# Append to grub.cfg
cat /boot/reinstall/grub.cfg >> /boot/grub/grub.cfg

# Set as default for next boot only
MENU_COUNT=$(grep -c "^menuentry" /boot/grub/grub.cfg)
NEW_ENTRY_INDEX=$((MENU_COUNT - 1))

if command -v grub-reboot >/dev/null 2>&1; then
    grub-reboot "$NEW_ENTRY_INDEX" 2>/dev/null || true
fi

echo ""
echo -e "${GREEN}==========================================================${PLAIN}"
echo -e "${GREEN}  Installation configured successfully!                   ${PLAIN}"
echo -e "${GREEN}==========================================================${PLAIN}"
echo -e ""
echo -e "System will ${YELLOW}reboot in 10 seconds${PLAIN} and begin installation."
echo -e "The installation process will take ${YELLOW}5-15 minutes${PLAIN}."
echo -e ""
echo -e "After installation, connect with:"
echo -e "  ${GREEN}ssh -p $SSH_PORT root@<your-ip>${PLAIN}"
echo -e "  ${GREEN}Password: $ROOT_PASS${PLAIN}"
echo -e ""
echo -e "${RED}IMPORTANT: Keep a record of these credentials!${PLAIN}"
echo -e "${RED}IMPORTANT: Keep this terminal open until you verify the new system!${PLAIN}"
echo -e "${RED}If something goes wrong, use console/VNC access to debug.${PLAIN}"
echo -e ""
echo -e "Press Ctrl+C within 10 seconds to cancel..."
echo ""

sleep 10
reboot
