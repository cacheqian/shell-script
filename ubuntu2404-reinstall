#!/bin/bash

# ==============================================================================
# Linux Network Reinstall Script (Secure Edition)
# Features:
# 1. Randomizes Root Password
# 2. Randomizes SSH Port
# 3. Direct DD install of Ubuntu 24.04
# ==============================================================================

# 检查是否为 root
[[ "$EUID" -ne '0' ]] && echo "Error: This script must be run as root!" && exit 1

# 安装依赖 (生成密码需要 openssl)
apt-get update -y >/dev/null 2>&1
apt-get install -y wget cpio gzip openssl >/dev/null 2>&1

# ==============================================================================
# 1. 生成随机凭证
# ==============================================================================

# 生成随机端口 (10000 - 65535)
SSH_PORT=$(shuf -i 10000-65535 -n 1)

# 生成随机密码 (16位强密码)
ROOT_PASS=$(openssl rand -base64 12)

# 清屏并重要提示
clear
echo -e "\033[31m==========================================================\033[0m"
echo -e "\033[31m   WARNING: SAVE THESE CREDENTIALS NOW!                   \033[0m"
echo -e "\033[31m==========================================================\033[0m"
echo -e ""
echo -e "Target System:  \033[32mUbuntu 24.04 LTS\033[0m"
echo -e "New Username:   \033[32mroot\033[0m"
echo -e "New Password:   \033[33m$ROOT_PASS\033[0m"
echo -e "New SSH Port:   \033[33m$SSH_PORT\033[0m"
echo -e ""
echo -e "Note: The system will be formatted. All data will be lost."
echo -e "\033[31m==========================================================\033[0m"
echo -e ""

# 强制用户确认，防止没记下来就重启了
read -p "I have saved the password and port. Press [Enter] to start install..."

# ==============================================================================
# 2. 准备 DD 镜像和环境
# ==============================================================================
echo -e "\n\033[36m# Preparing Environment...\033[0m"

# 基础镜像 URL (Ubuntu 24.04)
DD_IMAGE_URL="https://dl.lamp.sh/vhd/ubuntu_24.04_amd64.img.gz"

# 下载 Debian Loader
mkdir -p /boot/reinstall
cd /boot/reinstall
DEBIAN_MIRROR="http://deb.debian.org/debian/dists/bookworm/main/installer-amd64/current/images/netboot/debian-installer/amd64"

echo "Downloading loader..."
wget --no-check-certificate -qO linux "$DEBIAN_MIRROR/linux"
wget --no-check-certificate -qO initrd.gz "$DEBIAN_MIRROR/initrd.gz"

# ==============================================================================
# 3. 构造注入脚本 (核心魔法)
# ==============================================================================
# 这里的逻辑是在内存系统里执行的：
# 1. 下载并 DD 写入镜像
# 2. 重新挂载写入后的分区
# 3. 修改 shadow 文件(密码) 和 sshd_config(端口)
# 4. 允许 Root 登录 (以防镜像默认禁止)

cat > preseed.cfg <<EOF
d-i debian-installer/locale string en_US.UTF-8
d-i console-setup/ask_detect boolean false
d-i keyboard-configuration/xkb-keymap select us
d-i netcfg/choose_interface select auto
d-i netcfg/disable_autoconfig boolean false
d-i netcfg/get_nameservers string 8.8.8.8
d-i netcfg/confirm_static boolean true
d-i netcfg/hostname string localhost
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

d-i partman/early_command string \\
    echo "Starting Installation..." > /dev/console; \\
    MAIN_DISK=\$(list-devices disk | head -n1); \\
    if [ -z "\$MAIN_DISK" ]; then MAIN_DISK="/dev/sda"; fi; \\
    echo "Target Disk: \$MAIN_DISK" > /dev/console; \\
    echo "Downloading and Writing Image..." > /dev/console; \\
    wget --no-check-certificate -O- '$DD_IMAGE_URL' | gzip -d -c | dd of=\$MAIN_DISK bs=1M status=progress; \\
    echo "Syncing disk..." > /dev/console; \\
    sync; \\
    echo "Modifying Configuration..." > /dev/console; \\
    mkdir -p /mnt/target; \\
    mount \${MAIN_DISK}1 /mnt/target; \\
    if [ -d /mnt/target/etc ]; then \\
        echo "Setting Password..." > /dev/console; \\
        chroot /mnt/target /bin/bash -c "echo 'root:$ROOT_PASS' | chpasswd"; \\
        echo "Setting SSH Port to $SSH_PORT..." > /dev/console; \\
        sed -i 's/^#\?Port .*/Port $SSH_PORT/' /mnt/target/etc/ssh/sshd_config; \\
        sed -i 's/^#\?PermitRootLogin .*/PermitRootLogin yes/' /mnt/target/etc/ssh/sshd_config; \\
        sed -i 's/^#\?PasswordAuthentication .*/PasswordAuthentication yes/' /mnt/target/etc/ssh/sshd_config; \\
        echo "Config Updated." > /dev/console; \\
    else \\
        echo "Error: Could not mount target partition. Password not changed!" > /dev/console; \\
    fi; \\
    umount /mnt/target; \\
    echo "Rebooting..." > /dev/console; \\
    echo b > /proc/sysrq-trigger
EOF

# 打包 initrd
cp initrd.gz initrd.gz.orig
find . | cpio -H newc --create --verbose | gzip -9 > initrd.img
mv initrd.img /boot/reinstall/initrd.img

# ==============================================================================
# 4. 设置 GRUB 并重启
# ==============================================================================
GRUB_CFG="/boot/grub/grub.cfg"
cat >> "$GRUB_CFG" <<EOF
menuentry 'Secure Reinstall' {
    set root='$(grub-probe --target=drive /boot/reinstall/linux | sed 's/[()]/ /g' | awk '{print $1}')'
    linux /boot/reinstall/linux auto=true priority=critical file=/preseed.cfg
    initrd /boot/reinstall/initrd.img
}
EOF

# 尝试设置默认启动项
MENU_COUNT=$(grep -c "^menuentry" "$GRUB_CFG")
NEW_ENTRY_INDEX=$(($MENU_COUNT - 1))
if command -v grub-set-default >/dev/null; then
    grub-set-default "$NEW_ENTRY_INDEX"
elif command -v grub2-set-default >/dev/null; then
    grub2-set-default "$NEW_ENTRY_INDEX"
else
    sed -i "s/^set default=.*/set default=\"$NEW_ENTRY_INDEX\"/" "$GRUB_CFG"
fi

echo -e "\033[32mInstallation configured. System will reboot in 3 seconds.\033[0m"
sleep 3
reboot
